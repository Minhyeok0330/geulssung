{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>글쓰기 ✍️</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap');
    body { font-family: 'Gowun Batang', serif; }
    .step-nav-btn {
      padding: 6px 12px;
      border-radius: 9999px;
      font-weight: bold;
      color: #493E3E;
      background-color: #ffffff;
      border: 1px solid black;
      opacity: 0.6;
      transition: all 0.2s ease;
    }
    .step-nav-btn.active {
      background-color: #bae6fd;
      border: 1px solid black;
      opacity: 1;
    }
    .step-nav-btn.disabled {
      opacity: 0.3;
      pointer-events: none;
    }
  </style>
</head>
<body class="relative bg-[#FFF9F2] min-h-screen pb-24 p-8">
  <style>
    .background {
      background-image: url('{% static "images/바다만 덩그러니2.png" %}');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
  </style>

  <!-- 네비게이션 -->
  <div id="step-nav" class="fixed top-0 left-0 right-0 bg-white border-b shadow px-6 py-3 flex justify-center gap-4 z-50">
    <button class="step-nav-btn" onclick="goToStep(1)">1. 글감</button>
    <button class="step-nav-btn" onclick="goToStep(2)">2. 글줄기</button>
    <button type="button" onclick="toggleGuides()" class="step-nav-btn">💧 도움말</button>
    <a href="{% url 'home' %}" class="step-nav-btn ml-auto">🏠 홈으로</a>
  </div>

  <!-- 메인 폼 -->
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="flex gap-6 max-w-7xl mx-auto mt-24">

      <!-- 왼쪽: 글감 선택 + 가이드 -->
      <div class="w-1/2 bg-white shadow-xl rounded-xl p-6 space-y-6">
        {% include "post/write_form_left.html" %}
      </div>

      <!-- 오른쪽: 글쓰기 -->
      <div class="w-1/2 bg-white shadow-xl rounded-xl p-6 space-y-6">
        <div id="step-2" class="step" style="display: none;">
          <div>
            <label class="block font-semibold mb-1">커버 이미지 (선택)</label>
            <input type="file" name="cover_image" id="coverImageInput" accept="image/*" class="hidden" onchange="showCoverPreview(event)" />
            <button type="button" onclick="document.getElementById('coverImageInput').click();" class="bg-[#bae6fd] px-3 py-2 rounded-full text-sm">커버 선택</button>
            <div id="coverImagePreviewContainer" class="mt-4 hidden">
              <img id="coverImagePreview" src="#" class="w-full h-48 object-cover rounded-lg" />
            </div>
          </div>

          <div>
            <label class="block font-semibold mb-1">제목</label>
            <input type="text" name="title" class="w-full border px-3 py-2 rounded-md" required />
          </div>

          <div>
            <p class="font-bold text-lg mb-2">🧩 글줄기</p>
            <textarea name="final_text" rows="10" class="w-full border px-4 py-3 rounded-md shadow-sm" required></textarea>
          </div>

          <div class="flex justify-between">
            <button type="button" onclick="goToStep(1)" class="bg-gray-200 px-4 py-2 rounded-full">← 이전</button>
            <button type="submit" class="bg-[#bae6fd] px-6 py-3 rounded-full font-bold text-[#493E3E]">제출하기</button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <script>
    let currentStep = 1;
    let currentGenre = null;
    const genreMap = {
      essay: "에세이", poem: "시", column: "칼럼", analysis: "분석글"
    };
    let promptCache = {};

    function goToStep(step) {
      document.querySelectorAll('.step').forEach(s => s.style.display = 'none');
      document.getElementById(`step-${step}`)?.style.display = 'block';
      currentStep = step;
      updateStepNav();
    }

    function updateStepNav() {
      document.querySelectorAll(".step-nav-btn").forEach((btn, idx) => {
        btn.classList.toggle("active", idx + 1 === currentStep);
      });
    }

    function showCoverPreview(e) {
      const file = e.target.files[0];
      const img = document.getElementById('coverImagePreview');
      const container = document.getElementById('coverImagePreviewContainer');
      if (file) {
        const reader = new FileReader();
        container.style.display = 'block';
        reader.onload = e => img.src = e.target.result;
        reader.readAsDataURL(file);
      } else {
        container.style.display = 'none';
        img.src = '';
      }
    }

    function toggleGuides() {
      const box = document.getElementById("guides-combined");
      box.classList.toggle("hidden");
      const genre = document.querySelector('input[name="genre"]:checked')?.value;
      if (!genre) return;
      ['poem', 'essay', 'column', 'analysis'].forEach(id => {
        const g = document.getElementById(`guide-${id}`);
        if (g) g.hidden = (box.classList.contains("hidden") || id !== genre);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      goToStep(1);
    });
  </script>
</body>
</html>