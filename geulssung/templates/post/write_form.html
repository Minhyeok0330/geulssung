{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>글쓰기 ✍️</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap');
    body { font-family: 'Gowun Batang', serif; }

    .step-nav-btn {
      padding: 6px 12px;
      border-radius: 9999px;
      font-weight: bold;
      color: #493E3E;
      background-color: #F9DCC4;
      opacity: 0.6;
      transition: all 0.2s ease;
    }
    .step-nav-btn.active {
      background-color: #f7cbaa;
      opacity: 1;
    }
    .step-nav-btn.disabled {
      opacity: 0.3;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-[#FFF9F2] min-h-screen pb-24 p-8">

  <!-- 상단 고정 네비게이션 바 -->
  <div id="step-nav" class="fixed top-0 left-0 right-0 bg-white border-b shadow px-6 py-3 flex justify-center gap-4 z-50">
    <button class="step-nav-btn" onclick="goToStep(1)">1. 글감</button>
    <button class="step-nav-btn" onclick="goToStep(2)">2. 한 방울</button>
    <button class="step-nav-btn" onclick="goToStep(3)">3. 두 방울</button>
    <button class="step-nav-btn" onclick="goToStep(4)">4. 세 방울</button>
    <button class="step-nav-btn" onclick="goToStep(5)">5. 글줄기</button>
  </div>

  <!-- 본문 내용 (nav 높이만큼 상단 여백 추가) -->
  <div class="max-w-2xl mx-auto bg-white shadow-xl rounded-xl p-6 space-y-6 mt-24">
    <form method="post" action="">
      {% csrf_token %}
      <div class="step" id="step-1">
        <div class="mb-6">
          <p class="font-semibold text-[#493E3E]">오늘의 글쓰기 도우미</p>
          <div class="flex gap-4">
            <label><input type="radio" name="category" value="emotion" onchange="showGenres(this.value)"> F감성 글썽이</label>
            <label><input type="radio" name="category" value="logic" onchange="showGenres(this.value)"> T감성 말썽이</label>
          </div>
        </div>

        <div class="mb-6" id="genre-emotion" style="display:none;">
          <p class="font-semibold text-[#493E3E]">형식을 골라보세요 (글썽이)</p>
          <div class="flex gap-4">
            <label><input type="radio" name="genre" value="essay" onchange="showGuide(this.value)"> 에세이</label>
            <label><input type="radio" name="genre" value="poem" onchange="showGuide(this.value)"> 시</label>
          </div>
        </div>

        <div class="mb-6" id="genre-logic" style="display:none;">
          <p class="font-semibold text-[#493E3E]">형식을 골라보세요 (말썽이)</p>
          <div class="flex gap-4">
            <label><input type="radio" name="genre" value="column" onchange="showGuide(this.value)"> 칼럼</label>
            <label><input type="radio" name="genre" value="analysis" onchange="showGuide(this.value)"> 분석글</label>
          </div>
        </div>

        <div id="prompt-box" class="mb-6" style="display: none;">
          <p class="font-semibold text-[#493E3E] mb-2">🧠 오늘의 글감을 골라보세요</p>
          <div id="prompt-options" class="grid grid-cols-2 gap-4"></div>
          <input type="hidden" name="selected_prompt" id="selectedPrompt">
        </div>

        <div class="flex justify-between mt-4">
          <span></span>
          <button type="button" id="step1NextBtn" onclick="nextStep()" class="bg-[#F9DCC4] text-[#493E3E] font-bold px-4 py-2 rounded-full opacity-50 pointer-events-none">
            다음 →
          </button>
        </div>
      </div>

      <div id="guide-poem" style="display:none">{% include "post/_guide_poem.html" %}</div>
      <div id="guide-essay" style="display:none">{% include "post/_guide_essay.html" %}</div>
      <div id="guide-column" style="display:none">{% include "post/_guide_column.html" %}</div>
      <div id="guide-analysis" style="display:none">{% include "post/_guide_analysis.html" %}</div>

      <div class="step" id="step-5" style="display: none;">
        <div class="mb-6">
          <label class="block font-semibold text-[#493E3E] mb-1">제목</label>
          <input type="text" name="title" class="w-full border px-3 py-2 rounded-md" required />
        </div>

        <div class="mb-8 mt-8">
          <p class="font-bold text-[#493E3E] text-lg mb-2">🧩 글줄기: 하나의 글로 완성해보세요</p>
          <p class="text-sm text-gray-700 mb-3">
            위 단계별 작성 내용을 참고하여, 당신의 생각을 하나의 흐름 있는 글로 정리해보세요.<br />
            이 글은 실제 제출 및 공개 글로 사용될 수 있어요 ✍️
          </p>
          <textarea name="final_text" rows="10" class="w-full border px-4 py-3 rounded-md shadow-sm" required></textarea>
        </div>

        <div class="flex justify-between mt-4">
          <button type="button" onclick="prevStep()" class="bg-gray-200 px-4 py-2 rounded-full">← 이전</button>
          <button type="submit" class="bg-[#F9DCC4] hover:bg-[#f7cbaa] text-[#493E3E] font-bold px-6 py-3 rounded-full transition">
            제출하기
          </button>
        </div>
      </div>
    </form>
  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 5;

    function showGenres(category) {
      document.getElementById('genre-logic').style.display = category === 'logic' ? 'block' : 'none';
      document.getElementById('genre-emotion').style.display = category === 'emotion' ? 'block' : 'none';
      const all = ['column', 'analysis', 'essay', 'poem'];
      all.forEach(id => {
        const div = document.getElementById(`guide-${id}`);
        if (div) div.style.display = 'none';
      });
    }

    function showGuide(value) {
      const all = ['column', 'analysis', 'essay', 'poem'];
      all.forEach(id => {
        const div = document.getElementById(`guide-${id}`);
        if (div) div.style.display = 'none';
      });
      const target = document.getElementById(`guide-${value}`);
      if (target) target.style.display = 'block';
      showPrompts(value);
      checkFormReady();
    }

    function showPrompts(genre) {
      const promptBox = document.getElementById("prompt-box");
      const promptOptions = document.getElementById("prompt-options");
      const hiddenInput = document.getElementById("selectedPrompt");
      const promptMap = {
        poem: ["사라진 우산", "낙엽이 흔들린 날", "밤의 정류장", "우유 한 방울"],
        essay: ["무연고 장례", "버스 창밖", "학교 종이 땡땡땡", "엄마 손"],
        column: ["디지털 감시", "전세 사기", "청소년 투표권", "야근은 의무인가"],
        analysis: ["청년 고립", "기후 재난", "젠더 임금격차", "플랫폼 노동"]
      };
      const prompts = promptMap[genre] || [];
      promptOptions.innerHTML = "";
      hiddenInput.value = "";
      document.getElementById('step1NextBtn').classList.add('opacity-50', 'pointer-events-none');
      prompts.forEach(prompt => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "prompt-option border rounded-xl p-4 hover:bg-[#FFF4E6]";
        btn.textContent = prompt;
        btn.onclick = () => selectPrompt(btn, prompt);
        promptOptions.appendChild(btn);
      });
      promptBox.style.display = "block";
    }

    function selectPrompt(button, prompt) {
      document.querySelectorAll('.prompt-option').forEach(btn => {
        btn.classList.remove('bg-[#FFEFD6]', 'ring', 'ring-[#F9DCC4]');
      });
      button.classList.add('bg-[#FFEFD6]', 'ring', 'ring-[#F9DCC4]');
      document.getElementById('selectedPrompt').value = prompt;
      checkFormReady();
    }

    function checkFormReady() {
      const genre = document.querySelector('input[name="genre"]:checked');
      const prompt = document.getElementById('selectedPrompt').value;
      const btn = document.getElementById('step1NextBtn');
      if (genre && prompt) {
        btn.classList.remove('opacity-50', 'pointer-events-none');
      } else {
        btn.classList.add('opacity-50', 'pointer-events-none');
      }
    }

    function showStep(step) {
      const genre = document.querySelector('input[name="genre"]:checked')?.value;
      const allSteps = document.querySelectorAll('.step');
      allSteps.forEach(div => { div.style.display = 'none'; });
      const current = document.getElementById(`step-${genre}-${step}`) || document.getElementById(`step-${step}`);
      if (current) current.style.display = 'block';
      updateStepNav();
    }

    function nextStep() {
      if (currentStep === 1) {
        const genre = document.querySelector('input[name="genre"]:checked')?.value;
        if (!genre || !document.getElementById('selectedPrompt').value) {
          alert("형식과 글감을 모두 선택해주세요!");
          return;
        }
        const all = ['column', 'analysis', 'essay', 'poem'];
        all.forEach(id => {
          const div = document.getElementById(`guide-${id}`);
          if (div) div.style.display = 'none';
        });
        const target = document.getElementById(`guide-${genre}`);
        if (target) target.style.display = 'block';
        currentStep = 2;
      } else if (currentStep < totalSteps) {
        currentStep++;
      }
      showStep(currentStep);
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep = currentStep === 2 ? 1 : currentStep - 1;
        showStep(currentStep);
      }
    }

    function goToStep(step) {
      const genre = document.querySelector('input[name="genre"]:checked')?.value;
      if (step === 1 || (genre && document.getElementById('selectedPrompt').value)) {
        const targetId = document.getElementById(`step-${genre}-${step}`) || document.getElementById(`step-${step}`);
        if (targetId) {
          currentStep = step;
          showStep(currentStep);
        }
      } else {
        alert("먼저 형식과 글감을 선택해주세요!");
      }
    }

    function updateStepNav() {
      document.querySelectorAll(".step-nav-btn").forEach((btn, idx) => {
        btn.classList.remove("active", "disabled");
        if (idx + 1 === currentStep) {
          btn.classList.add("active");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      showStep(currentStep);
    });
  </script>
</body>
</html>
